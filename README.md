# New Primo UI

[![Docker Repository on Quay](https://quay.io/repository/nyulibraries/primo-explore-devenv/status "Docker Repository on Quay")](https://quay.io/repository/nyulibraries/primo-explore-devenv)
[![CircleCI](https://circleci.com/gh/NYULibraries/primo-explore-devenv.svg?style=svg)](https://circleci.com/gh/NYULibraries/primo-explore-devenv)

## Setting up the dev environment

### Settings
* PROXY_SERVER: Used for specifying the discovery server used by the development server.
* VIEW: Which Primo View will be served. (matches directory in `primo-explore/custom/{VIEW}`)
* VE: Set as a string "true" to use VE settings
* SAML: Set as string "true" to use SAML authentication method

### Local

With Node.js (>=8) and yarn installed:

```sh
yarn install --frozen-lockfile
```

Then start the server up:

```
PROXY_SERVER=http://bobcatdev.library.nyu.edu:80 VIEW=NYU [VE='true' SAML='true'] yarn start
```

Your developer server will be accessible at `http://localhost:8004/primo-explore/search?vid={VIEW}`

### Docker

With Docker and docker-compose installed:

1. Configure `docker-compose.yml` to fit your institutional setup in the `x-environment` section.
1. `docker-compose build web`
1. `VIEW=NYU docker-compose up web`

On your local machine, the developer server will be accessible at `http://localhost:8004/primo-explore/search?vid={VIEW}`

Within the [docker network](https://docs.docker.com/network/), this will be accordingly be accessible at domian `http://web:8004`

## JS, (S)CSS, & HTML

All imports of JavaScript and (S)CSS will occur as `import` statements in your `js/main.js` or `@import` statements in `css/sass/main.scss` files. These are resolved by the `webpack` bundler with assets generated. `js/main.js` and`css/sass/main.scss` files are considered webpack's `entry` files.

To use HTML as a JavaScript `String` in your code (e.g. for an Angular.js template), `import` and use in your `main.js`

#### Example

```scss
/* main.scss */
/* import local sass */
@import 'variables';

/* import relative CSS files */
@import '../css/app-colors.css';

/* Manually import css assets that are delivered with NPM modules */
@import '~primo-explore-libraryh3lp-widget/css/custom1.css';
```

```js
/* Import any node dependencies */
import 'primo-explore-libraryh3lp-widget';

/* Import other JS files relative to main.js */
import libraryh3lpWidgetConfig from './libraryh3lpWidget';

/* HTML imported as a string for use in JS */
import customRequestsRequestInformationTemplate from '../html/custom_requests_request_information.html';

let app = angular.module('viewCustom', [
  'libraryh3lpWidget',
]);

app
  .constant(libraryh3lpWidgetConfig.name, libraryh3lpWidgetConfig.config)
  .component('prmLocationItemsAfter', {
    template: `${customRequestsRequestInformationTemplate}`
  });
```

Tree:
```sh
├── primo-explore
│   ├── custom
│   │   ├── NYU
│   │   │   ├── README.md
│   │   │   ├── colors.json
│   │   │   ├── css
│   │   │   │   ├── app-colors.css
│   │   │   │   ├── custom1.css # Generated by webpack
│   │   │   │   ├── custom1.css.map # Generated by webpack
│   │   │   │   ├── main.css
│   │   │   │   └── sass
│   │   │   │       ├── _availability.scss
│   │   │   │       ├── _chat_widget.scss
│   │   │   │       ├── _custom_request.scss
│   │   │   │       ├── _hide.scss
│   │   │   │       ├── _logo.scss
│   │   │   │       ├── _variables.scss
│   │   │   │       └── main.scss
│   │   │   ├── html
│   │   │   │   ├── custom_requests_request_information.html
│   │   │   │   └── home_en_US.html
│   │   │   ├── img
│   │   │   ├── js
│   │   │   │   ├── clickableLogoToAnyLink.js
│   │   │   │   ├── custom.js # Generated by webpack
│   │   │   │   ├── custom.js.map # Generated by webpack
│   │   │   │   └── libraryh3lpWidget.js
```

## Docker image

This docker image is intended for usage within other view package repositories. Our image can be pulled from `quay.io/nyulibraries/primo-explore-devenv` [(image repository)](https://quay.io/repository/nyulibraries/primo-explore-devenv?tab=info)

#### Example

```dockerfile
FROM quay.io/nyulibraries/primo-explore-devenv:1.1.1

ENV VIEW NYU
ENV DEVENV_PATH /app

WORKDIR /app/primo-explore/

# Installs Node modules, along with inner repository node_modules
COPY yarn.lock package.json ./
COPY custom/CENTRAL_PACKAGE/package.json ./custom/CENTRAL_PACKAGE/package.json
COPY custom/NYU/package.json ./custom/NYU/package.json
COPY custom/NYUAD/package.json ./custom/NYUAD/package.json
COPY custom/NYUSH/package.json ./custom/NYUSH/package.json
COPY custom/NYSID/package.json ./custom/NYSID/package.json
COPY custom/NYHS/package.json ./custom/NYHS/package.json
COPY custom/BHS/package.json ./custom/BHS/package.json
COPY custom/CU/package.json ./custom/CU/package.json

# Installs production version of dependencies from NPM
RUN yarn install --prod --frozen-lockfile --ignore-optional && yarn cache clean

# Copies remaining VIEW files
COPY ./custom/ ./custom/

# Sets up for running as a container
WORKDIR ${DEVENV_PATH}

EXPOSE 8004 3001

# CMD not necessary: inherited from devenv
```

## Build a Package

### Locally

```sh
VIEW=[view] NODE_ENV=[stage] yarn create-package
```

### Docker

With volumes enabled in the `docker-compose.yml`:

```sh
VIEW=[view] NODE_ENV=[stage] docker-compose run create-package
```

## Deploys

Deploys must be done through the back office UI with an uploaded zip package.

1. **Notify admins and devs** by scheduling a block in the appropriate Primo calendar. This ensures no conflicts between manual deploys and jobs.

1. **Build a package.** Run `docker-compose create-package` to build a zip file of this customization package. The script also removes files that cause the upload to fail, specifically any files except `package.json` without the following extensions: `png`, `jpg`, `gif`, `js`, `html`, `css`.

1. **Verify that no deploys or pipes are running or scheduled.** Under Monitor Primo Status, check the following to ensure nothing is running or scheduled (Jobs need about 15 minutes after completion to finish before a deploy can be run.):
    - Schedule Tasks
    - Deploy Monitoring
    - Process Monitoring
    - Job Monitoring

1. **Upload zip file.** Navigate to Deploy & Utilities > Customization Manager. Select the appropriate view (e.g. "NYU") as View. Download the existing package in case of failure. Choose file and click "Upload".

1. **Deploy** by clicking "Deploy." You can monitor progress under "Deploy Monitoring."

## Resources

- [Legacy Docs: The Gulp Environment](https://github.com/NYULibraries/primo-explore-devenv/wiki/Legacy:-Gulp-Environment)
- [ExLibris Javascript recipes](https://github.com/ExLibrisGroup/primo-explore-package/blob/master/VIEW_CODE/js/README.md)
- [ExLibris CSS recipes](https://github.com/ExLibrisGroup/primo-explore-package/blob/master/VIEW_CODE/css/README.md)
- [ExLibris Primo New UI overview](https://github.com/ExLibrisGroup/primo-explore-devenv)
- [ExLibris Primo New UI best practices](https://knowledge.exlibrisgroup.com/Primo/Product_Documentation/New_Primo_User_Interface/New_UI_Customization_-_Best_Practices)
- [ExLibris Primo New UI package manager](https://knowledge.exlibrisgroup.com/Primo/Product_Documentation/Back_Office_Guide/090Primo_Utilities/The_UI_Customization_Package_Manager)
- [Community contributions](https://github.com/search?utf8=%E2%9C%93&q=primo-explore)
